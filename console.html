<html>
<head>
<style>

.shellwindow{
  position:fixed;
  
  top:0px;
  left:0px;
  right:0px;
  bottom:0px;
}

</style>
  
<script src='system/boot/WLogger.js'></script>
<script src='system/boot/WLibrary.js'></script>
<script src='system/boot/WLibraryManager.js'></script>
<script src='system/boot/bootloader.js'></script>

<script src='system/packages.js'></script>

</head>
<body>

<div class='shellwindow'></div>

<script>
(function(){
  
  var wshell;
  
  window.onload = function(){
    BOOTLOADER.setPackages(PACKAGES);
    BOOTLOADER.preload('WShell', OnShellLoad);
  }
  function OnShellLoad(){
    wshell = new WShell(document.querySelector('.shellwindow'));
    BOOTLOADER.launch();
  }
  
  window.didBootLaunch = function(){
    var libraryList = BOOTLOADER.getLibraryManager().getIdentifierList();
    WLogger.inform('ENV Launched with Libraries:', libraryList.join(', '));
    
    
    
    var parser = new WScripting([
  
      {
        'command': 'mkdir',
        'args': 'dirname',
        'kwargs': '',
        'flags': 'p v',
        'worker': DoMakeDir
      },
      // p ~ fills in directories
      // v ~ is verbose in filling in directories
      
      {
        'command': 'ls',
        'args': 'dirname',
        'kwargs': '',
        'flags': '',
        'worker': ListDir
      }
  
    ]);
    
    

    function DoMakeDir(obj){
      var path = new WPath(obj.dirname);
      
      if(obj.p){
        MakeDirectoryWithFillin(path, obj.v);
      }else{
        WLocalDrive.makeDirectory(path);
        if(obj.v) WLogger.inform('Directory created:', path.getPathAsString());
      }
    }
    function MakeDirectoryWithFillin(wpath, isverbose){
      var lastDir;
      
      var subpaths = wpath.getSubPaths();
      for(var i=0,path; path=subpaths[i++];){
        if(WLocalDrive.exists(path)){
          if(isverbose) WLogger.inform('Directory exists:', path.getPathAsString());
        }else{
          lastDir = WLocalDrive.makeDirectory(path);
          if(isverbose) WLogger.inform('Directory created:', path.getPathAsString());
        }
      }

      if(lastDir == undefined)
        return WLocalDrive.locatePath(wpath);
      return lastDir;
    }
    
    function ListDir(obj){
      var dir = WLocalDrive.locatePath(new WPath(obj.dirname));
      var children = dir.getChildren();
      
      for(var i=0,child; child=children[i++];){
        if (child instanceof WDirectory) WLogger.inform(child.getDirectoryName());
        else return WLogger.inform(child.getFileBlob().getFileName());
      }
    }
    
    
    WLogger.inform('WScripting initialized with commands:', parser.getCommands().join(', '));
    
    
    wshell.setParser(parser);
    wshell.start();
    
    
        //
    // parser.execute('mkdir test');
    // // parser.execute('mkdir --force --lolol --test lol arg --test lol2');
    // // parser.execute('mkdir --force --test lol arg --test lol2');
    // // parser.execute('mkdir --force arg --test');
    // // parser.execute('mkdir arg --test --force lol');
    // parser.execute('mkdir --force arg --test lol');
    // parser.execute('mkdir --force --test lol arg');
    // parser.execute('mkdir --dirname test');
    // parser.execute('mkdir test --force');
    // parser.execute('mkdir --force test');
    //
    // parser.execute('mkdir --force "this is a test"');
    // parser.execute('mkdir --test "test again" "this is a test"');
    // // parser.execute('mkdir --test "test again" this is a test"');
    // // parser.execute('mkdir "test again\\\\" this is a test"');
    // parser.execute('mkdir "test again\\\" this is a test"');
    //
    
    return
    
        //
    // WLocalDrive.loadFromLocalStorage();
    //
    // var file = WLocalDrive.locatePath(new WPath('/test/asd/test.lol'));
    // console.log(file.getFileBlob().getContent())
    //
    // return
    //
    
    // Inspect(new WPath('/users/temp/test.txt'))
    // Inspect(new WPath('/users/temp/../..'))
    // Inspect(new WPath('users/temp/archive.rar'))
    // Inspect(new WPath('/users'))
    // Inspect(new WPath('/').concat('./homework.txt'))
    // Inspect(new WPath('/').concat('./users'))
    // Inspect(new WPath('/users').concat('..'))
    // Inspect(new WPath('/users').concat('../..'))
    
    WLocalDrive.makeDirectory(new WPath('/test'));
    WLocalDrive.makeDirectory(new WPath('/test/asd'));
    
    // WLocalDrive.makeDirectory(new WPath('/test'));
    // WLocalDrive.makeDirectory(new WPath('/test/lol.txt'));
    
    // WLocalDrive.makeDirectory(new WPath('/tests/asd'));
    
    WLocalDrive.writeFile(
      new WFile({
        'path': new WPath('/test/asd'),
        'blob': new WFileBlob({ name:'test.lol', content:'is this working?' })
      })
    );
    
    WLocalDrive.saveToLocalStorage();
  }
  
  function Inspect(wpath){
    console.log(wpath.getPathAsString());
    console.log(WLocalDrive.exists(wpath))
    console.log(WLocalDrive.isDirectory(wpath))
    console.log(WLocalDrive.isFile(wpath))
    console.log(WLocalDrive.locatePath(wpath));
  }
  
})();
</script>
<body>
</html>