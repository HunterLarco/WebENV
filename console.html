<html>
<head>
<style>

.shellwindow{
  position:fixed;
  
  top:0px;
  left:0px;
  right:0px;
  bottom:0px;
  
  background:rgb(15,15,15);
}

</style>
  
<script src='system/boot/WLogger.js'></script>
<script src='system/boot/WLibrary.js'></script>
<script src='system/boot/WLibraryManager.js'></script>
<script src='system/boot/bootloader.js'></script>

<script src='system/packages.js'></script>

</head>
<body>

<div class='shellwindow'></div>

<script>
(function(){
  
  var wshell;
  
  window.onload = function(){
    BOOTLOADER.setPackages(PACKAGES);
    BOOTLOADER.preload('WShell', OnShellLoad);
  }
  function OnShellLoad(){
    wshell = new WShell(document.querySelector('.shellwindow'));
    BOOTLOADER.launch();
  }
  
  window.didBootLaunch = function(){
    var libraryList = BOOTLOADER.getLibraryManager().getIdentifierList();
    WLogger.inform('ENV Launched with Libraries:', libraryList.join(', '));
    
    
    
    var parser = new WScripting([
  
      {
        'command': 'mkdir',
        'args': 'dirname',
        'flags': 'fill verbose',
        'worker': DoMakeDir,
        'description': 'Makes directories'
      },
      
      {
        'command': 'ls',
        'args': 'dirname[./]',
        'flags': 'all',
        'worker': ListDir,
        'description': 'Lists files and folder in the current directory'
      },
      
      {
        'command': 'cd',
        'args': 'path',
        'flags': '',
        'worker': CurrentDirectory,
        'description': 'Changes the current directory'
      },
      
      {
        'command': 'help',
        'args': 'command[]',
        'flags': '',
        'worker': CommandInfo,
        'description': 'Prints the command specs for a given command'
      },
      
      {
        'command': 'clear',
        'args': '',
        'flags': '',
        'worker': ClearShell,
        'description': 'Clears the shell'
      },
      
      {
        'command': 'pwd',
        'args': '',
        'flags': '',
        'worker': PrintDirectory,
        'description': 'Prints the current directory'
      },
      
      {
        'command': 'write',
        'args': 'filename text',
        'flags': 'append',
        'worker': WriteTextFile,
        'description': 'Writes text to a file'
      },
      
      {
        'command': 'read',
        'args': 'filename',
        'flags': '',
        'worker': ReadTextFile,
        'description': 'Reads a text file'
      }
      
    ]);
    
    
    var workingDirectory = new WPath('/');

    function DoMakeDir(obj){
      var pathString = obj.dirname;
      var path = workingDirectory.concat(pathString);
      
      if(obj.fill){
        MakeDirectoryWithFillin(path, obj.verbose);
      }else{
        WLocalDrive.makeDirectory(path);
        if(obj.verbose) WLogger.inform('Directory created:', path.getPathAsString());
      }
    }
    function MakeDirectoryWithFillin(wpath, isverbose){
      var lastDir;
      
      var subpaths = wpath.getSubPaths();
      for(var i=0,path; path=subpaths[i++];){
        if(WLocalDrive.exists(path)){
          if(isverbose) WLogger.inform('Directory exists:', path.getPathAsString());
        }else{
          lastDir = WLocalDrive.makeDirectory(path);
          if(isverbose) WLogger.inform('Directory created:', path.getPathAsString());
        }
      }

      if(lastDir == undefined)
        return WLocalDrive.locatePath(wpath);
      return lastDir;
    }
    
    function ListDir(obj){
      var wpath = workingDirectory.concat(obj.dirname);
      var dir = WLocalDrive.locatePath(wpath);
      
      if(dir instanceof WFile){
        WLogger.error('Not a directory:', wpath.getPathAsString());
        throw 'Not a directory';
      }
      
      if(obj.all){
        var output = ListNestedDir(dir);
        if(output.length === 0)
          return 'Directory is empty';
        return output.join('\n');
      }
      
      var output = [];
      
      var children = dir.getChildren();
      
      for(var i=0,child; child=children[i++];){
        if (child instanceof WDirectory) output.push(child.getDirectoryName());
        else output.push(child.getFileBlob().getFileName());
      }
      
      if(output.length === 0)
        return 'Directory is empty';
      return output.join('\n');
    }
    function ListNestedDir(dir){
      if(dir instanceof WFile) return [];
      
      var children = dir.getChildren();
      var output = [];
      
      for(var i=0,child; child=children[i++];){
        output.push(child.getPath().getPathAsString());
        output = output.concat(ListNestedDir(child));
      }
      
      return output;
    }
    
    function CurrentDirectory(obj){
      var pathString = obj.path;
      var newDirectory = workingDirectory.concat(pathString);

      if(!WLocalDrive.isDirectory(newDirectory)){
        WLogger.error('Not a directory:', newDirectory.getPathAsString());
        throw 'Not a directory';
      }
      
      workingDirectory = newDirectory;
      
      wshell.setMountString(workingDirectory);
    }
    
    function CommandInfo(obj){
      var command = obj.command;
      
      if(command.length === 0)
        return PrintAllCommands();
      
      var parser = wshell.getParser();
      var commandSpec = parser.getCommandSpec(command)
      return commandSpec.getHelpString();
    }
    function PrintAllCommands(){
      var commands = wshell.getParser().getCommands();
      var response = '';
      
      response += 'Commands\n';
      response += '\t' + commands.join('\n\t') + '\n\n';
      response += 'Type \'help [command]\' for help using a specific command.';
      
      return response;
    }
    
    function ClearShell(){
      wshell.clear();
    }
    
    function PrintDirectory(){
      return workingDirectory.getPathAsString();
    }
    
    function WriteTextFile(obj){
      var filename = obj.filename;
      var filepath = workingDirectory.concat(filename)
      var text = obj.text;
      
      var shouldAppend = obj.append;
      var originalText = '';
      
      if(shouldAppend){
        var fileText = ReadTextFile({ filename: filename });
        fileText += '\n';
        originalText = fileText;
      }
      
      var file = new WFile({
        'path': filepath,
        'blob': new WFileBlob({
          'name': filename,
          'content': originalText + text
        })
      });
      
      WLocalDrive.writeFile(file);
    }
    function ReadTextFile(obj){
      var filename = obj.filename;
      var filepath = workingDirectory.concat(filename)
      
      var isFile = WLocalDrive.isFile(filepath);
      if(!isFile){
        WLogger.error('Not a file:', filepath.getPathAsString());
        throw 'Not a file';
      }
      
      var file = WLocalDrive.locatePath(filepath);
      var blob = file.getFileBlob();
      var text = blob.getContent();
      
      return text;
    }
    
    WLogger.inform('WScripting initialized with commands:', parser.getCommands().join(', '));
    
    
    wshell.setParser(parser);
    wshell.start();
    
  }
  
  function Inspect(wpath){
    console.log(wpath.getPathAsString());
    console.log(WLocalDrive.exists(wpath))
    console.log(WLocalDrive.isDirectory(wpath))
    console.log(WLocalDrive.isFile(wpath))
    console.log(WLocalDrive.locatePath(wpath));
  }
  
})();
</script>
<body>
</html>