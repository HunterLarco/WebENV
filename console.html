<html>
<head>
<style>

body{
  padding:0px;
  margin:0px;
  
  background:rgb(245,245,245);
  color:rgb(40,40,40);
  
  font-size:0px;
  font-family:helvetica, arial;
}

article{
  display:block;
  
  margin:0px auto;
  max-width:700px;
}

article h1{
  font-size:30px;
  font-weight:bold;
  text-align:center;
  
  margin:60px 0px;
  padding:0px;
}
article h2{
  font-size:19px;
  font-weight:bold;
  text-transform:uppercase;
  
  margin:6px 0px;
  padding:0px;
}
article h2+p{
  margin-top:0px;
}
article p{
  font-size:17px;
  font-weight:300;
  
  margin:35px 0px;
  padding:0px;
}

playground{
  display:block;
  position:relative;
  
  background:rgb(230,230,230);
  font-family:'Cousine', helvetica;
}
playground .table{
  display:table;
  width:100%;
}
playground line{
  display:table-row;
}
playground line:first-of-type num{
  padding-top:12px;
}
playground line:last-of-type num{
  padding-bottom:12px;
}
playground line num{
  display:table-cell;
  padding:0px 20px 0px 12px;
  width:1px;
  
  font-size:14px;
  line-height:23px;
  
  background:rgb(238,238,238);
  color:rgb(80,80,80);
  
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  -khtml-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}
playground line.error num{
  color:rgb(233,30,99);
}
playground line text{
  display:table-cell;
  padding:0px 12px 0px 8px;
  
  font-size:16px;
  line-height:23px;
}
playground line error{
  display:table-cell;
  width:1px;
  
  font-size:14px;
  line-height:23px;
  white-space:nowrap;
  text-align:right;
  
  padding-right:12px;
  
  color:rgb(233,30,99);
}

playground .menu{
  position:block;
  
  background:rgb(225,225,225);
  
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  -khtml-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}
playground .menu item{
  display:inline-block;
  vertical-align:top;
  
  font-size:12px;
  padding:6px 12px;
  
  background:rgb(215,215,215);
  border-right:1px solid rgb(225,225,225);
  
  cursor:pointer;
}
playground .menu item:hover{
  background:rgb(202,202,202);
}

simulator{
  display:block;
  
  position:fixed;
  top:0px;
  left:0px;
  width:100%;
  height:100%;
  
  background:rgb(96,125,139);
}

simulator .close{
  position:absolute;
  top:0px;
  right:0px;
  z-index:1;
  
  margin:20px;
  
  width:46px;
  height:46px;
  
  opacity:0.8;
  cursor:pointer;
}
simulator .close:hover{
  opacity:1;
}

simulator .layout{
  display:flex;
  flex-flow:column;
  width:100%;
  height:100%;
}
simulator .layout .code{
  background:rgb(245,245,245);
}
simulator .layout .visual{
  flex:2;
  position:relative;
  
  margin:20px;
}
simulator .layout .visual img{
  position:absolute;
  
  top:0px;
  left:0px;
  width:100%;
  height:100%;
  
  object-fit:contain;
}

</style>

<script src='./simulator/wire.js'></script>
<script src='./simulator/pingroup.js'></script>
<script src='./simulator/pinconnector.js'></script>
<script src='./simulator/binarypingroup.js'></script>
<script src='./simulator/register.js'></script>
<script src='./simulator/ram.js'></script>
<script src='./simulator/incrementor.js'></script>
<script src='./simulator/controlunit.js'></script>
<script src='./simulator/bus.js'></script>
<script src='./simulator/alu.js'></script>

<script src='./playgrounds/scripts/catalog.js'></script>
<script src='./playgrounds/scripts/interpreter.js'></script>

<link href='https://fonts.googleapis.com/css?family=Cousine:400,700' rel='stylesheet' type='text/css'>

</head>
<body>


<article>
  <h1>How does a computer really work?</h1>
  <h2>assembly language</h2>
  <p>Lets start with some basic (very basic) computer code</p>
  
  <playground>
    <line>ADD 1</line>
    <line>CMP 20</line>
    <line>JUMPEQ 4</line>
    <line>JUMP 0</line>
    <line>END</line>
  </playground>
  
  <p>What does this do exactly? Lets look at the parts. It adds 1, the compares that value to 20. If it is equal to 20 it ends the program, if not it repeats.</p>
</article>


<simulator>
  <img class='close' src='./simulator/images/icons/close.png'/>
  
  <div class='layout'>
    <div class='visual'>
      <img src='./simulator/images/visual/components.png'/>
    </div>
    <div class='code'>
      <playground>
        <line>ADD 1</line>
        <line>CMP 20</line>
        <line>JUMPEQ 4</line>
        <line>JUMP 0</line>
        <line>END</line>
      </playground>
    </div>
  </div>
</simulator>


<script>
(function(){
  
  var PARTS = {
    databus0  : './simulator/images/visual/bus/data/0bit',
    databus2  : './simulator/images/visual/bus/data/2bit',
    databus4  : './simulator/images/visual/bus/data/4bit',
    databus8  : './simulator/images/visual/bus/data/8bit',
    databus16 : './simulator/images/visual/bus/data/16bit',
    databus32 : './simulator/images/visual/bus/data/32bit',
    databus64 : './simulator/images/visual/bus/data/64bit',
    databus128: './simulator/images/visual/bus/data/128bit',
    
    instbus0  : './simulator/images/visual/bus/instruction/0bit',
    instbus2  : './simulator/images/visual/bus/instruction/2bit',
    instbus4  : './simulator/images/visual/bus/instruction/4bit',
    instbus8  : './simulator/images/visual/bus/instruction/8bit',
    instbus16 : './simulator/images/visual/bus/instruction/16bit',
  };
  
  window.addEventListener('load', Init);
  function Init(){
    FormAllPlaygrounds();
    
    var partFrame = document.querySelector('simulator .visual');
    PreloadParts(PARTS, partFrame, OnPreloadProgress, OnPartsReady);
    
    function OnPreloadProgress(progress){
      console.log(progress);
    }
    function OnPartsReady(elems){
      console.log(elems);
    }
    
    // var simulator = new Simulator('ADD 1\nCMP 20\nJUMPEQ 4\nJUMP 0\nEND');
    // simulator.addEventListener('clock', function(){
      // console.log(simulator.getAccumulator());
    // });
    // simulator.run(200);
  }
  
  
  function PreloadParts(parts, frame, onprogress, callback){
    var totalParts = 0;
    var partsLoaded = 0;
    var elems = {};
    
    for(var part in parts)
      (function(part){
        totalParts += 2;
      
        var baseUrl = parts[part];
        var off = baseUrl + '.png';
        var on = baseUrl + '-on.png';
      
        var imageOff = new Image();
        imageOff.addEventListener('load', ImageLoaded);
        imageOff.src = off;
        imageOff.style.display = 'none'
        frame.appendChild(imageOff);
      
        var imageOn = new Image();
        imageOn.addEventListener('load', ImageLoaded);
        imageOn.src = on;
        imageOn.style.display = 'none'
        frame.appendChild(imageOn);
      
        function ImageLoaded(){
          elems[part] = {
            on: imageOn,
            off: imageOff
          }
          
          var percent = ++partsLoaded / totalParts;
          onprogress(percent);
          if(percent === 1) callback(elems);
        }
      })(part);
  }
  
  
  function FormAllPlaygrounds(){
    var playgrounds = document.querySelectorAll('playground');
    
    for(var i=0,playground; playground=playgrounds[i++];)
      FormPlayground(playground);
  }
  function FormPlayground(playground){
    var lines = GetCodeFromPlayground(playground);
    
    var menu = document.createElement('div');
    menu.setAttribute('class', 'menu');
    
    FormButton(menu, 'Run', new Function());
    FormButton(menu, 'Step Forward', new Function());
    FormButton(menu, 'Reset', new Function());
    FormButton(menu, 'View Catalog', new Function());
    FormButton(menu, 'View Machine Code', new Function());
    FormButton(menu, 'View Simulation', new Function());
    
    var table = document.createElement('div');
    table.setAttribute('class', 'table');
    
    var lines = GetCodeFromPlayground(playground);
    for(var i=0; i<lines.length; i++){
      var line = document.createElement('line');
      var lineText = lines[i];
      
      var number = document.createElement('num');
      number.innerHTML = i+1;
      
      var text = document.createElement('text');
      text.innerHTML = lineText;
      
      var error = document.createElement('error');
      InterpretLine(lineText, function(err){
        if(!err) return;
        error.innerHTML = err;
        line.setAttribute('class', 'error');
      });
      
      line.appendChild(number);
      line.appendChild(text);
      line.appendChild(error);
      table.appendChild(line);
    }
    
    playground.innerHTML = '';
    playground.appendChild(menu);
    playground.appendChild(table);
  }
  function FormButton(menu, title, listener){
    var item = document.createElement('item');
    item.innerHTML = title;
    item.addEventListener('click', listener);
    menu.appendChild(item);
  }
  function GetCodeFromPlayground(playground){
    var lines = playground.querySelectorAll('line');
    var code = [];
    
    for(var i=0; i<lines.length; i++)
      code.push(lines[i].innerHTML);
    
    return code;
  }
  
})();
</script>
<body>
</html>